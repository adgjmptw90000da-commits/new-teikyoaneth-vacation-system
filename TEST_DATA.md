# テストデータ説明書

## テストデータの適用方法

### ローカル開発環境

```bash
# Docker Desktopを起動

# Supabaseローカル環境の起動
supabase start

# マイグレーション実行（テストデータを含む）
supabase db reset
```

### テストデータのみを再生成

既にデータベースがセットアップされている場合:

```bash
# SQLファイルを直接実行
supabase db execute -f supabase/migrations/20241118999999_test_data.sql
```

## テストユーザー一覧

### 管理者アカウント

| 職員ID | 氏名 | パスワード | 用途 |
|--------|------|-----------|------|
| 99001 | 山田太郎 | password123 | 管理者機能のテスト |
| 99002 | 佐藤花子 | password123 | 複数管理者のテスト |

### 一般ユーザーアカウント

| 職員ID | 氏名 | パスワード | 用途 |
|--------|------|-----------|------|
| 99003 | 鈴木一郎 | password123 | 年休申請のテスト（1月6件、2月6件） |
| 99004 | 田中美咲 | password123 | 年休申請のテスト（1月6件、2月6件） |
| 99005 | 高橋健太 | password123 | 年休申請のテスト（1月6件、2月6件） |
| 99006 | 伊藤さくら | password123 | 年休申請のテスト（1月6件、2月6件） |
| 99007 | 渡辺大輔 | password123 | 年休申請のテスト（1月6件、2月6件） |
| 99008 | 山本優子 | password123 | 年休申請のテスト（1月6件、2月6件） |
| 99009 | 中村誠 | password123 | 年休申請のテスト（1月6件、2月6件） |
| 99010 | 小林愛 | password123 | 年休申請のテスト（1月6件、2月6件） |

## テストデータ概要

### 申請データ統計

**総申請数**: 100件
- **2026年1月**: 50件
- **2026年2月**: 50件

**全申請のステータス**: `before_lottery`（抽選前）

**レベル別分布**:
- レベル1: 約30件（必ず取りたい）
- レベル2: 約40件（取りたい）
- レベル3: 約30件（取れたら取りたい）

**期間別分布**:
- 全日: 約60件
- AM（午前半休）: 約20件
- PM（午後半休）: 約20件

### 抽選参加期間フラグ

`is_within_lottery_period`は以下のルールで設定されています:
- **レベル1・2**: `true`（抽選参加期間内の申請として扱う）
- **レベル3**: `false`（抽選参加期間外の申請として扱う）

これにより、動的判定機能のテストが可能になります。

## テストシナリオ

### 1. 基本的な抽選処理のテスト

**目的**: 100件の申請に対して抽選処理を実行し、優先順位が正しく付与されることを確認

**手順**:
1. 管理者（99001）でログイン
2. 管理カレンダーページにアクセス
3. 2026年1月を表示
4. 「一括抽選実施」ボタンをクリック
5. 各日付の申請に優先順位が付与されることを確認
6. 2026年2月でも同様に実行

**期待結果**:
- レベル1の申請が最優先（優先順位1〜）
- レベル2の申請が次（レベル1の後）
- レベル3の申請が最後（レベル2の後）
- 同一レベル内ではランダムな順序
- 申請のステータスが`after_lottery`に変更される

### 2. マンパワー設定と確定処理のテスト

**目的**: マンパワーを設定し、確定処理で上限まで確定、それ以降は取り下げになることを確認

**手順**:
1. 管理者（99001）でログイン
2. 2026年1月5日を選択（複数の申請がある日）
3. マンパワーを「3名」に設定
4. 抽選実施（まだの場合）
5. 確定処理を実行
6. 優先順位1〜3の申請が「確定」になることを確認
7. 優先順位4以降の申請が「取り下げ」になることを確認

**期待結果**:
- 上位3名が確定ステータスになる
- 4名目以降は取り下げステータスになる
- カレンダー管理のステータスが`confirmation_completed`になる

### 3. カレンダー表示の動的判定テスト

**目的**: システム設定による表示/非表示の制御を確認

**手順**:
1. 管理者設定で`show_lottery_period_applications`を`false`に設定
2. ユーザーカレンダーを確認
3. 抽選参加期間内（`is_within_lottery_period = true`）の申請が非表示になることを確認
4. `show_lottery_period_applications`を`true`に変更
5. すべての申請が表示されることを確認

**期待結果**:
- 設定が`false`の場合、抽選期間内の申請は非表示
- 設定が`true`の場合、すべての申請が表示

### 4. 優先順位表示の動的判定テスト

**目的**: 申請一覧での優先順位表示の制御を確認

**手順**:
1. ユーザー（99003）でログイン
2. 申請一覧を表示
3. 抽選前は優先順位が表示されないことを確認
4. 管理者で抽選実施
5. 再度申請一覧を確認
6. 抽選参加期間外（`is_within_lottery_period = false`）の申請のみ優先順位が表示されることを確認

**期待結果**:
- 抽選前: 優先順位なし（"-"）
- 抽選後: レベル3（期間外）のみ優先順位表示
- 設定で`show_lottery_period_applications = true`の場合: すべて表示

### 5. キャンセル機能のテスト（動的判定）

**目的**: レベル1・2のキャンセルが抽選参加期間内のみ可能であることを確認

**テストケース1: 抽選参加期間内の申請**
- `is_within_lottery_period = true`の申請を選択
- キャンセルボタンが表示されることを確認
- キャンセル実行 → 成功

**テストケース2: 抽選参加期間外の申請**
- レベル3（`is_within_lottery_period = false`）の申請を選択
- キャンセルボタンが表示されることを確認（レベル3は常に可能）
- キャンセル実行 → 成功

**期待結果**:
- レベル1・2: 抽選期間内のみキャンセル可能
- レベル3: 確定・取り下げ・承認待ち前なら常にキャンセル可能

### 6. 大量データでのパフォーマンステスト

**目的**: 100件の申請データでカレンダー表示や一括処理が正常に動作することを確認

**手順**:
1. ユーザーカレンダーで2026年1月を表示
2. 50件の申請が正しく表示されることを確認
3. 管理カレンダーで一括抽選実施
4. 処理時間を確認（目安: 10秒以内）
5. 一括確定処理を実行
6. 処理時間を確認（目安: 10秒以内）

**期待結果**:
- 50件の申請が問題なく表示される
- 一括処理が適切な時間内で完了する
- エラーが発生しない

### 7. 承認待ち申請のテスト（事前準備が必要）

**目的**: 確定後のレベル3申請で承認待ちステータスになることを確認

**手順**:
1. 2026年1月5日の全申請に対して抽選実施
2. マンパワーを「5名」に設定して確定処理
3. ユーザー（99003）でログイン
4. 2026年1月5日のレベル3申請を新規作成
5. 申請が`pending_approval`ステータスで作成されることを確認
6. 管理者で承認待ち申請ページにアクセス
7. 承認または却下を実行

**期待結果**:
- 確定後のレベル3申請は承認待ちステータスになる
- 管理者が承認すると確定ステータスになる
- 管理者が却下するとキャンセルステータスになる

## 機能別テストチェックリスト

### ユーザー機能

- [ ] ログイン（99003でログイン）
- [ ] 年休申請（レベル1・2・3、全日・AM・PM）
- [ ] 申請一覧表示（自分の申請6+6=12件表示）
- [ ] 申請キャンセル（抽選参加期間内のレベル1・2、確定前のレベル3）
- [ ] 年休カレンダー表示（全申請100件が適切に表示）
- [ ] 個人情報設定（氏名・パスワード変更）

### 管理者機能

- [ ] 管理者ログイン（99001でログイン）
- [ ] マンパワー設定（日別で設定）
- [ ] 抽選実施（一括・日別）- 100件が正しく処理される
- [ ] 確定処理（一括・日別）- マンパワー上限で正しく確定/取り下げ
- [ ] 確定解除（個別で解除可能）
- [ ] 個別キャンセル（管理者による強制キャンセル）
- [ ] 承認待ち申請の承認・却下
- [ ] メンバー管理（権限変更・削除）
- [ ] 祝日管理（追加・編集・削除）
- [ ] 管理者設定（組織コード・抽選期間・表示設定）

### バージョン 1.1 新機能

- [ ] **カレンダー表示の動的判定**
  - 設定による表示/非表示の切り替え確認

- [ ] **優先順位表示の動的判定**
  - 抽選前後での表示切り替え確認

- [ ] **レベル3の申請制限**
  - 抽選期間前の申請がエラーになることを確認

- [ ] **レベル1・2のキャンセル制限**
  - 抽選参加期間内のみキャンセル可能であることを確認

## テストデータのクリーンアップ

テストデータを削除する場合:

```sql
-- テストユーザーと関連申請を削除
DELETE FROM application WHERE staff_id >= '99000' AND staff_id <= '99999';
DELETE FROM "user" WHERE staff_id >= '99000' AND staff_id <= '99999';
```

または、データベース全体をリセット:

```bash
supabase db reset
```

## 注意事項

- **本番環境での使用禁止**: このテストデータは開発・テスト環境でのみ使用してください
- **日付の調整**: テストデータの日付は2026年に設定されています。現在の日付によっては調整が必要な場合があります
- **パスワード**: すべてのテストユーザーのパスワードは `password123` です
- **職員ID**: テストユーザーの職員IDは `99` で始まる（99001-99010）ため、本番データと区別しやすくなっています
- **申請の分布**: 各ユーザーが1月・2月それぞれ5〜6件ずつ申請しており、合計100件になっています

## トラブルシューティング

### 「vacation_date は未来日のみ」エラー

テストデータの日付が過去になっている場合、以下のいずれかを実施:

1. SQLファイル内の日付を未来の日付に変更
2. または、テスト時のシステム日付を2025年に設定

### テストデータが表示されない

1. マイグレーションが正しく適用されているか確認:
   ```bash
   supabase db reset
   ```

2. ブラウザのキャッシュをクリア

3. ログアウト→ログインし直す

### 抽選処理が実行できない

- 申請のステータスが`before_lottery`であることを確認
- マイグレーションファイルを再実行してデータをリセット

### 確定処理が実行できない

- 抽選処理が完了していることを確認（ステータスが`after_lottery`）
- マンパワーが設定されていることを確認

## データ統計

### ユーザー別申請数

| ユーザー | 1月 | 2月 | 合計 |
|----------|-----|-----|------|
| 99003 | 6 | 6 | 12 |
| 99004 | 6 | 6 | 12 |
| 99005 | 6 | 6 | 12 |
| 99006 | 6 | 6 | 12 |
| 99007 | 6 | 6 | 12 |
| 99008 | 6 | 6 | 12 |
| 99009 | 6 | 6 | 12 |
| 99010 | 6 | 6 | 12 |
| **合計** | **50** | **50** | **100** |

### 申請が集中する日付（1月）

- 1月5日、8日、13日、19日、26日など - 複数ユーザーの申請が重複
- これにより抽選・確定処理のテストに最適

### 申請が集中する日付（2月）

- 2月2日、5日、10日、16日、23日など - 複数ユーザーの申請が重複
- これにより抽選・確定処理のテストに最適
