# 年休管理システム

職員の年休を管理するWebアプリケーションです。

## 技術スタック

- **フロントエンド**: Next.js 15 + TypeScript + Tailwind CSS
- **バックエンド・データベース**: Supabase (PostgreSQL)
- **デプロイ**: Vercel (フロントエンド) + Supabase (バックエンド・DB)
- **認証**: カスタム実装 (LocalStorage)

## プロジェクト概要

このシステムは、組織内の職員が年休を申請・管理し、管理者が抽選・確定処理を行うためのシステムです。

## 機能一覧

### 一般ユーザー機能

1. **認証機能**
   - 組織コード認証 (`/auth/organization`)
   - 新規登録 (`/auth/register`)
   - ログイン (`/auth/login`)

2. **年休申請機能**
   - 新規申請 (`/applications/new`)
     - 期間選択: 全日・AM・PM
     - レベル選択: レベル1（必ず休みたい）、レベル2（可能な限り休みたい）、レベル3（余裕があれば休みたい）
     - 備考入力
   - 申請一覧 (`/applications`)
     - 申請履歴の確認
     - 申請のキャンセル
     - ステータス表示（抽選前、抽選済み、確定、取り消し、キャンセル、承認待ち）

3. **カレンダー表示**
   - 年休カレンダー (`/calendar`)
     - 月別の年休状況確認
     - 全職員の年休申請を視覚化
     - 抽選期間内申請の表示/非表示切り替え（設定による）

4. **個人設定**
   - プロフィール設定 (`/settings/profile`)
     - 氏名変更
     - パスワード変更

### 管理者機能

5. **管理カレンダー** (`/admin/calendar`)
   - マンパワー（定員）設定
   - 抽選実施（一括・日別）
   - 確定処理（一括・日別）
   - 確定解除
   - 個別キャンセル
   - 抽選期間内申請の表示/非表示切り替え（設定による）

6. **承認待ち申請管理** (`/admin/approvals`)
   - 確定処理後のレベル3申請の承認・却下
   - 枠状況の確認（確定者数 / マンパワー）

7. **メンバー管理** (`/admin/members`)
   - ユーザー一覧表示
   - 管理者権限の付与・解除（トグル形式）
   - ユーザー削除
   - 自分自身と最後の管理者は変更・削除不可

8. **祝日・主要学会管理** (`/settings/holidays`)
   - 祝日・主要学会の登録・編集・削除
   - 祝日・主要学会一覧表示

9. **イベント管理** (`/settings/events`)
   - イベントの登録・編集・削除
   - イベント一覧表示
   - カレンダー上に表示されるが申請制限はなし（祝日・主要学会とは別）

10. **管理者設定** (`/settings/admin`)
    - 組織コード変更
    - 抽選参加期間設定（何ヶ月前の何日〜何日）
    - カレンダー表示設定（抽選期間内申請の表示/非表示）

11. **データ削除** (`/admin/data-cleanup`)
    - 年度別データの一括削除
    - 申請、カレンダー、祝日・主要学会、イベントの削除

## データベース構造

### `user` テーブル
職員情報を管理

| カラム名 | 型 | 説明 |
|---------|-----|------|
| staff_id | VARCHAR (PRIMARY KEY) | 職員ID（数字のみ） |
| name | VARCHAR | 氏名 |
| password | VARCHAR | パスワード（平文保存） |
| is_admin | BOOLEAN | 管理者フラグ |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

### `setting` テーブル
組織設定（1行のみ）

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | INTEGER (PRIMARY KEY) | ID（常に1） |
| organization_code | VARCHAR | 組織コード |
| lottery_period_months | INTEGER | 抽選参加可能期間（何ヶ月前）デフォルト: 3 |
| lottery_period_start_day | INTEGER | 抽選参加開始日 デフォルト: 1 |
| lottery_period_end_day | INTEGER | 抽選参加終了日 デフォルト: 15 |
| show_lottery_period_applications | BOOLEAN | 抽選期間内申請を表示するか デフォルト: true |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

### `application` テーブル
年休申請情報

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | SERIAL (PRIMARY KEY) | 申請ID |
| staff_id | VARCHAR (FOREIGN KEY) | 職員ID |
| applied_at | TIMESTAMP | 申請日時 |
| vacation_date | DATE | 年休取得希望日 |
| period | VARCHAR | 期間（full_day, am, pm） |
| level | INTEGER | レベル（1, 2, 3） |
| is_within_lottery_period | BOOLEAN | 抽選参加期間内か |
| status | VARCHAR | ステータス（before_lottery, after_lottery, confirmed, withdrawn, cancelled, pending_approval） |
| priority | INTEGER | 優先順位 |
| remarks | TEXT | 備考 |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

**制約**:
- `staff_id` と `vacation_date` の組み合わせは一意
- `vacation_date` は未来日のみ

### `calendar_management` テーブル
日別の管理情報

| カラム名 | 型 | 説明 |
|---------|-----|------|
| vacation_date | DATE (PRIMARY KEY) | 対象日 |
| max_people | INTEGER | マンパワー（定員） |
| status | VARCHAR | ステータス（before_lottery, after_lottery, confirmation_completed） |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

### `holiday` テーブル
祝日・主要学会マスタ

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | SERIAL (PRIMARY KEY) | 祝日・主要学会ID |
| holiday_date | DATE (UNIQUE) | 祝日・主要学会 |
| name | VARCHAR | 祝日・主要学会名 |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

### `event` テーブル
イベント情報（申請制限なし）

| カラム名 | 型 | 説明 |
|---------|-----|------|
| id | SERIAL (PRIMARY KEY) | イベントID |
| event_date | DATE (UNIQUE) | イベント日付 |
| name | VARCHAR | イベント名 |
| created_at | TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | 更新日時 |

## 年休申請システムの仕組み

### レベルの概念

- **レベル1**: 必ず休みたい（最優先）
- **レベル2**: 可能な限り休みたい（中優先）
- **レベル3**: マンパワーに余裕があれば休みたい（低優先）

### 抽選参加期間

設定で「何ヶ月前の何日〜何日」を指定できます（デフォルト: 3ヶ月前の1日〜15日）。

例: 6月の年休申請は3月1日〜15日に申請可能

- **期間内のレベル1・2申請**: 抽選対象
- **期間外のレベル3申請**: 抽選対象外、申請順で優先順位が決まる

### ワークフロー

1. **申請** - ユーザーが年休申請を行う（ステータス: `before_lottery`）
2. **抽選** - 管理者が抽選を実施（ステータス: `after_lottery`）
   - レベル1 → レベル2 → 期間内レベル3（シャッフル）→ 期間外レベル3（申請順）の順で優先順位付け
3. **確定処理** - 管理者がマンパワー（定員）を設定し、確定処理を実施
   - 優先順位順にマンパワーまで確定（ステータス: `confirmed`）
   - それ以降は取り消し（ステータス: `withdrawn`）
   - カレンダー管理のステータスが `confirmation_completed` になる

### 確定処理後のレベル3申請（承認待ち機能）

確定処理が完了した日に対して、マンパワーに余裕がある場合のみレベル3申請が可能です。

- **マンパワー上限到達**: 申請不可（エラー表示）
- **マンパワーに余裕あり**: 申請可能（ステータス: `pending_approval`）
- **管理者の承認**:
  - 承認 → ステータスが `confirmed` に変更
  - 却下 → ステータスが `cancelled` に変更

**承認待ち申請の特徴**:
- ユーザーは自分でキャンセルできない（管理者が承認・却下を判断）
- 優先順位は設定されない
- 承認待ち申請一覧で枠状況（確定者数 / マンパワー）を確認可能

### バリデーションルール

- 日曜日は申請不可
- 祝日・主要学会は申請不可
- 土曜日のPMは申請不可
- 未来日のみ申請可能
- 同一日付に重複申請不可
- レベル1・2は抽選参加期間内のみ申請可能

### キャンセル可能条件

- **レベル1・2**: 抽選参加期間内のみキャンセル可能
- **レベル3**: 確定・取り消し・承認待ち前ならキャンセル可能
- **承認待ち**: ユーザーはキャンセル不可（管理者が却下する）

## 画面フロー

```
トップページ (/)
  ↓ (未ログイン時)
ログイン画面 (/auth/login)
  ↓
ホーム画面 (/home)
  ├→ 年休申請 (/applications/new)
  ├→ 申請一覧 (/applications)
  ├→ 年休カレンダー (/calendar)
  ├→ 個人情報設定 (/settings/profile)
  └→ 管理者機能 ※管理者のみ
      ├→ 管理カレンダー (/admin/calendar)
      ├→ 承認待ち申請 (/admin/approvals)
      ├→ メンバー管理 (/admin/members)
      ├→ 祝日・主要学会管理 (/settings/holidays)
      └→ 管理者設定 (/settings/admin)

新規登録の場合:
組織コード認証 (/auth/organization)
  ↓ (正しいコード入力)
新規登録 (/auth/register)
  ↓
ログイン画面 (/auth/login)
```

## セットアップ手順

### 1. リポジトリのクローン

```bash
cd /path/to/your/directory
```

### 2. 依存関係のインストール

```bash
npm install
```

### 3. Supabaseプロジェクトの作成

1. [Supabase](https://supabase.com/)にアクセスし、新規プロジェクトを作成
2. プロジェクトのURL（Project URL）とANON KEY（公開キー）をコピー

### 4. 環境変数の設定

`.env.local` ファイルを作成し、以下を記載：

```bash
# Supabase接続情報
NEXT_PUBLIC_SUPABASE_URL=your-project-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
```

### 5. Supabaseマイグレーションの実行

#### ローカル開発の場合

```bash
# Docker Desktopを起動

# Supabaseローカル環境の起動
supabase start

# マイグレーション実行
supabase db reset
```

#### 本番環境の場合

```bash
# Supabaseプロジェクトとリンク
supabase link --project-ref your-project-ref

# マイグレーション実行
supabase db push
```

### 6. 開発サーバーの起動

```bash
npm run dev
```

ブラウザで [http://localhost:3000](http://localhost:3000) を開く

### 7. 初期管理者アカウントの作成

1. 組織コード認証画面で組織コード `teikyo0629` を入力
2. 新規登録画面で管理者アカウントを作成
3. Supabaseダッシュボードで `user` テーブルを開く
4. 作成したアカウントの `is_admin` を `true` に変更

## マイグレーション管理

このプロジェクトでは、Supabase CLIを使用してデータベーススキーマを管理しています。

### マイグレーションファイルの場所

`supabase/migrations/` ディレクトリ内に配置されています。

### 現在のマイグレーション

1. `20241118000001_initial_schema.sql` - 初期スキーマ（user、settingテーブル）
2. `20241118000002_vacation_application.sql` - 年休申請システム（application、calendar_management、holidayテーブル、抽選期間設定）
3. `20241118000003_fix_unique_constraint.sql` - ユニーク制約の修正
4. `20241118000004_add_show_lottery_period_setting.sql` - 抽選期間内申請表示設定の追加
5. `20241118000005_add_pending_approval_status.sql` - 承認待ちステータスの追加
6. `20241119000001_add_annual_leave_points.sql` - 年休得点システムの追加
7. `20241119000002_add_holidays_2025_2027.sql` - 2025-2027年の祝日・主要学会データ追加
8. `20241119000003_convert_to_timestamptz.sql` - タイムスタンプ型をTIMESTAMPTZに変換
9. `20241121000001_add_level3_points.sql` - レベル3の得点設定追加
10. `20241122000001_add_priority_exchange_log.sql` - 優先順位交換ログテーブル追加
11. `20241122000003_add_cascade_delete_to_priority_exchange_log.sql` - 優先順位交換ログテーブルのカスケード削除設定
12. `20241123000001_add_cancellation_features.sql` - キャンセル機能追加（cancellation_requestテーブル、新ステータス）

### 新しいマイグレーションの作成

```bash
# 新しいマイグレーションファイルを作成
supabase migration new migration_name

# マイグレーション実行
supabase db reset  # ローカル
supabase db push   # 本番
```

### 重要な注意事項

**マイグレーション管理を徹底すること**

- データベースの変更は必ずマイグレーションファイルとして記録
- Supabaseダッシュボードから直接スキーマを変更しない
- マイグレーションファイルはバージョン管理に含める
- README.mdは変更があるたびに更新する

## ディレクトリ構造

```
new-Vacation-system/
├── app/                          # Next.js App Router
│   ├── admin/                    # 管理者機能
│   │   ├── approvals/           # 承認待ち申請管理
│   │   ├── calendar/            # 管理カレンダー
│   │   └── members/             # メンバー管理
│   ├── applications/            # 年休申請
│   │   └── new/                # 新規申請
│   ├── auth/                    # 認証関連
│   │   ├── login/              # ログイン
│   │   ├── organization/       # 組織コード認証
│   │   └── register/           # 新規登録
│   ├── calendar/               # 年休カレンダー
│   ├── home/                   # ホーム画面
│   └── settings/               # 設定
│       ├── admin/              # 管理者設定
│       ├── holidays/           # 祝日・主要学会管理
│       └── profile/            # 個人設定
├── lib/                         # ライブラリ・ユーティリティ
│   ├── application.ts          # 申請関連のロジック
│   ├── auth.ts                 # 認証ロジック
│   ├── database.types.ts       # TypeScript型定義
│   ├── dateUtils.ts           # 日付ユーティリティ（タイムゾーン対応）
│   ├── supabase.ts            # Supabase クライアント
│   └── validation.ts          # バリデーション
└── supabase/
    └── migrations/             # データベースマイグレーション
```

## 開発・デプロイ

### ローカル開発

```bash
npm run dev
```

### ビルド

```bash
npm run build
```

### 本番デプロイ（Vercel）

1. [Vercel](https://vercel.com/)にログイン
2. GitHubリポジトリと連携
3. 環境変数を設定（`NEXT_PUBLIC_SUPABASE_URL`、`NEXT_PUBLIC_SUPABASE_ANON_KEY`）
4. デプロイ

## セキュリティについて

このシステムは組織内での使用を想定しており、高度なセキュリティは実装していません：

- パスワードは平文で保存
- RLS（Row Level Security）は未設定
- セッション管理はLocalStorage

将来的にセキュリティを強化する場合は、以下を検討してください：

- パスワードのハッシュ化
- JWTトークンの使用
- RLSの有効化
- HTTPS通信の強制

## 変更履歴

### 2024-11-18 - バージョン 1.0

**初期バージョン**
- Next.js + TypeScript + Tailwind CSSプロジェクトの作成
- Supabaseセットアップ（user、settingテーブル）
- 認証フロー実装（組織コード認証、新規登録、ログイン）
- ホーム画面実装
- 個人情報設定画面実装（氏名・パスワード変更）
- 管理者設定画面実装（組織コード変更）

**年休申請システムの実装**
- データベーススキーマの追加（application、calendar_management、holidayテーブル）
- 年休申請機能（新規申請、申請一覧、キャンセル）
- 抽選機能（一括・日別、レベル別優先順位付け）
- 確定処理機能（一括・日別、マンパワー管理）
- 年休カレンダー表示（月別、全職員の申請状況）
- 管理カレンダー（抽選・確定処理の実行）
- 祝日・主要学会管理機能
- 抽選参加期間設定
- バリデーション実装（日曜・祝日・主要学会・未来日チェックなど）

**追加機能の実装**
- 抽選期間内申請の表示/非表示設定
- 年休カレンダー・管理カレンダー・申請一覧での表示設定連動
- メンバー管理機能（管理者権限付与・削除、安全機能）
- 確定処理後のレベル3申請機能（承認待ち）
- 承認待ち申請管理画面（承認・却下機能）

### 2024-11-18 - バージョン 1.1

**表示ロジックの動的判定化**
- カレンダー表示の動的判定実装
  - 従来: 申請時点での `is_within_lottery_period` フラグで固定判定
  - 変更後: 現在の日付と年休取得希望日の関係で動的に判定
  - 新関数: `isCurrentlyInLotteryPeriodForDate()` を追加
  - 影響範囲: ユーザーカレンダー、管理カレンダー
- 優先順位表示の動的判定実装
  - 申請一覧で優先順位の表示/非表示を動的に判定
  - 抽選参加期間中は優先順位を非表示、期間外は表示

**申請制限の追加**
- レベル3の申請可能期間を制限
  - 従来: 抽選参加期間前でもレベル3申請可能
  - 変更後: 抽選参加期間以降のみレベル3申請可能
  - 新関数: `isBeforeLotteryPeriod()` を追加
  - エラーメッセージ: "レベル3は抽選参加期間以降のみ申請可能です"

**キャンセルロジックの動的判定化**
- レベル1・2のキャンセル可能期間を動的判定に変更
  - 従来: 申請時点での `is_within_lottery_period` フラグで固定判定
  - 変更後: 現在の日付が抽選参加期間内かどうかで動的に判定
  - 具体例: 2026年2月の年休申請（抽選期間: 2025年11月1-15日）
    - 2025年11月1-15日の間 → キャンセル可能
    - 2025年11月16日以降 → キャンセル不可
  - 影響範囲: 申請一覧ページ（`app/applications/page.tsx`の`canCancel`関数）

**テストデータの整備**
- テストユーザー10名の自動生成（職員ID: 99001-99010）
- 8つのテストシナリオを網羅するデータセット
- マイグレーションファイル: `20241118999999_test_data.sql`
- ドキュメント: `TEST_DATA.md`

### 2024-11-19 - バージョン 1.2

**年休得点システムの実装**
- ユーザーテーブルに得点保持率カラムを追加（`point_retention_rate`）
- 設定テーブルに現在の年度カラムを追加（`current_fiscal_year`）
- 年休得点計算ロジックの実装
  - レベル1確定: -1.0点
  - レベル2確定: -0.5点
  - レベル1申請（未確定）: -0.6点
  - レベル2申請（未確定）: -0.3点
  - 得点保持率に応じて上限得点を調整（デフォルト: 100%）
- ホーム画面と年休申請画面に得点状況を表示
- メンバー管理画面で得点保持率を編集可能に

**祝日・主要学会データの追加**
- 2025年〜2027年の祝日・主要学会データを自動登録

**UI/UX改善（モバイル対応）**
- カレンダーページのモバイルレスポンシブ対応
  - 月移動ボタン: モバイルでは矢印のみ表示、デスクトップでは「← 前月」「次月 →」
  - 4ヶ月タブ: モバイルでは月のみ表示、デスクトップでは年月表示
  - 凡例レイアウト: 1列（モバイル）→ 2列（タブレット）→ 4列（デスクトップ）
  - 日付ヘッダー: 縦並び（モバイル）→ 横並び（デスクトップ）
  - タッチターゲットサイズ: 最小44pxを確保
- 管理カレンダーのレイアウト改善
  - 月移動とアクションボタンを分離（モバイル時は縦積み）

**テキスト色の視認性改善**
- カレンダーページの文字色を修正（`text-gray-900`を明示的に指定）
  - 年月タイトル（2025年11月など）
  - 凡例タイトルと各レベルラベル
  - 「確定以外」ボックスの文字色
- フォーム入力欄の文字色を修正
  - 年休申請フォーム: 日付・期間・レベル選択・備考入力欄
  - 祝日・主要学会管理: 日付・名前入力欄
  - メンバー管理: 得点保持率入力欄
  - 管理カレンダー: 枠数入力欄
  - プレースホルダー色も明示的に指定（`placeholder:text-gray-400`）

**タイムゾーン問題の修正**
- 問題: データベースにUTCで保存された日時が、ブラウザ表示時に9時間ズレる
- 解決策:
  1. すべての日時表示に`timeZone: "Asia/Tokyo"`を追加
     - ユーザー登録日時（メンバー管理）
     - 申請日時（申請一覧、承認待ち申請）
     - 休暇日表示（申請一覧）
  2. データベースのタイムスタンプ型を`TIMESTAMP`から`TIMESTAMPTZ`に変換
     - マイグレーション: `20241119000003_convert_to_timestamptz.sql`
     - タイムゾーン情報をデータベースレベルで保持
  3. 日付ユーティリティ関数を作成（`lib/dateUtils.ts`）
     - 日本時間での日付取得・フォーマット関数
     - タイムゾーンを考慮した日付処理を統一

**その他の改善**
- ホーム画面ヘッダーをシンプル化
  - 名前表示を削除し、「一般」「管理者」のロール表示のみに変更

### 2024-11-21 - バージョン 1.3

**年休得点表示の統一**
- 共通コンポーネント `PointsStatus` の作成
  - ホーム画面と年休申請画面で統一された表示
  - レベル1、2、3の申請数と確定数を対等に表示
  - 3カラムレイアウトで各レベルを均等に配置
  - スケルトンローダーによるレイアウトシフト防止
- 年休得点計算ロジックの改善
  - `calculateAnnualLeavePoints` 関数にレベル3のカウント機能を追加
  - `pending_approval` ステータスを含めるように修正（レベル3の確定後申請に対応）
  - 確定数と申請数の分類を明確化
    - 確定数: `status === 'confirmed'`
    - 申請数: `before_lottery`, `after_lottery`, `pending_approval`

**UI/UX改善**
- 年休得点カードのデザイン改善
  - 各レベルを色分け（レベル1: 赤、レベル2: 青、レベル3: 緑）
  - 確定数と申請数を並列表示
  - 残りポイントを大きく強調表示

### 2024-11-22 - バージョン 1.4

**キャンセル機能の実装**
- キャンセル承認テーブル（`cancellation_request`）の追加
  - 期間外キャンセルの管理者承認フロー
  - 承認時の得点回復機能
  - 却下時の理由記録
- 新しいステータスの追加
  - `pending_cancellation`: キャンセル承認待ち
  - `cancelled_before_lottery`: 期間外キャンセル承認済み（得点回復）
  - `cancelled_after_lottery`: 抽選後キャンセル（得点消費済み）
- キャンセルロジックの改善
  - 期間内: 即座にキャンセル、得点回復
  - 期間外（抽選前）: 管理者承認が必要、承認後に得点回復
  - 抽選後: 即座にキャンセル、得点回復なし
- 管理者承認画面の拡張
  - キャンセル承認待ちセクションの追加
  - レベル3承認待ちとキャンセル承認待ちを同じ画面で管理

**優先順位・レベル交換機能**
- 管理カレンダーでの優先順位とレベルの交換機能
  - 同一日付の2つの申請を選択して交換
  - 確定済み申請は交換不可
  - 優先順位とレベルを同時に交換
- 交換ログテーブル（`priority_exchange_log`）の追加
  - 交換履歴の記録（誰が、いつ、どの申請を交換したか）

**年休得点表示の改善**
- 得点状況の詳細表示
  - 従来: 申請中・確定の2分類
  - 改善後: 申請中・確定・抽選後キャンセルの3分類
  - 各レベルの消費得点を個別表示
- `calculateAnnualLeavePoints` 関数の拡張
  - 抽選後キャンセルのカウント追加
  - 各レベルの消費得点を個別計算
  - より詳細な得点状況の提供
- PointsStatusコンポーネントの改修
  - 3分類表示対応
  - 消費得点を境界線で区切って強調表示
  - 「抽選後キャンセル」表記に統一（誤解防止）

**UI/UX改善**
- カラーパレットの調整
  - 薄緑: #dcfce7 → #D6E2CC
  - 薄赤: #fee2e2 → #F8CCCC
  - 枠線・テキスト色も視認性向上のため調整
- ステータス表示の統一
  - キャンセル関連ステータスの色を統一（カスタムカラー使用）
  - カレンダー、申請一覧、管理画面で一貫した表示
- ホーム画面の承認待ち件数表示
  - 承認待ち申請アイコンに未処理件数バッジを追加
  - レベル3承認待ち + キャンセル承認待ちの合計を表示
  - アニメーション付き赤バッジで視認性向上

**データベース構造の拡張**
- `application` テーブル
  - ステータス制約にキャンセル関連ステータスを追加
- `setting` テーブル
  - `level3_points` カラム追加（レベル3の得点設定）
- `cancellation_request` テーブル（新規）
  - キャンセル申請履歴の管理
- `priority_exchange_log` テーブル（新規）
  - 優先順位交換履歴の管理

### 2024-11-22 - バージョン 1.4.1

**管理者機能の改善**
- ホーム画面の承認待ち件数表示の統合
  - レベル3承認待ち + キャンセル承認待ちの合計件数を表示
  - 未処理申請の見逃し防止
- メンバー管理画面の機能拡張
  - 残り年休得点の表示
    - 各ユーザーの現在の残り得点を一覧表示
    - 色分け表示（緑: 10点超、黄: 5-10点、赤: 5点以下）
  - 全カラムのソート機能
    - 職員ID、氏名、登録日時、得点保持率、残り得点でソート可能
    - 昇順・降順の切り替え対応
    - ソート方向を示すアイコン表示

**UI/UX改善**
- メンバー管理画面の視認性向上
  - 残り得点を色分けバッジで表示し、得点状況を直感的に把握可能
  - クリック可能なヘッダーでソート操作を簡単化
  - ソート状態を視覚的にフィードバック

### 2024-11-22 - バージョン 1.4.2

**バグ修正**
- キャンセル済み日付への再申請問題の修正
  - 一度年休申請をしてキャンセルした日に別の申請をすると「申請の保存に失敗しました」となる問題を修正
  - ユニーク制約にキャンセル済みステータスを除外するよう調整
- 日本語表現の改善
  - キャンセルアラートメッセージを自然な日本語に修正（「得点が回復されます」→「得点が回復します」）

**確定後レベル3申請の優先順位機能**
- 承認待ち（pending_approval）申請に優先順位を付与
  - 申請時に仮の優先順位を設定（カレンダー表示用）
  - 承認時に正式な優先順位を再計算（承認順で付与）
  - 同一日付の複数の承認待ち申請でもカレンダー上で正しく表示可能

**ユーザー体験の改善**
- 抽選後キャンセルの2段階確認アラート追加
  - 1回目: 通常の確認（「キャンセルしますか？」）
  - 2回目: 得点回復なしの警告（「本当にキャンセルしますか。年休得点は回復しません。」）
  - 誤操作による意図しないキャンセルを防止

**データベース改善**
- 優先順位交換ログテーブルのカスケード削除設定
  - `priority_exchange_log` テーブルの外部キー制約に `ON DELETE CASCADE` を追加
  - 申請レコード削除時に関連する交換ログも自動的に削除
  - データ整合性の向上とマニュアル削除の手間を削減

**タイムゾーン処理の統一化**
- 日本時間（JST）処理の完全統一
  - `lib/application.ts`: 全ての `new Date()` を `getJSTDate()` に置き換え（4箇所）
  - `lib/application.ts`: 日付文字列生成を `formatDateToYYYYMMDD()` に統一（2箇所）
  - `lib/validation.ts`: 日付比較処理を日本時間基準に修正
  - `lib/dateUtils.ts` のユーティリティ関数を全面活用
- タイムゾーンのずれによる日付バグを完全に解消
  - 23時以降の申請で翌日にずれる問題を修正
  - データベース（UTC）とアプリケーション（JST）の日付表示を一貫化

**技術的な改善**
- タイムゾーン処理の中央集約化
  - `dateUtils.ts` を使用した統一的な日付処理
  - メンテナンス性とバグ発生リスクの低減

## トラブルシューティング

### Docker関連エラー

```
Cannot connect to the Docker daemon
```

→ Docker Desktopを起動してから `supabase start` を実行してください

### マイグレーションエラー

既存のデータベースとの不整合がある場合:

```bash
# ローカル環境をリセット
supabase db reset
```

### 型エラー

TypeScript型定義が古い場合、最新のマイグレーションに合わせて `lib/database.types.ts` を更新してください。

## ライセンス

このプロジェクトは内部使用を目的としています。

## 開発者向けメモ

### 新しい機能を追加する際の注意点

1. **データベース変更**: 必ずマイグレーションファイルを作成
2. **型定義更新**: `lib/database.types.ts` を更新
3. **README更新**: 機能一覧と変更履歴を更新
4. **バリデーション**: 必要に応じて `lib/validation.ts` にバリデーション関数を追加
5. **エラーハンドリング**: ユーザーフレンドリーなエラーメッセージを実装

### コーディング規約

- **ファイル名**: kebab-case（例: `new-application.tsx`）
- **コンポーネント名**: PascalCase（例: `NewApplicationPage`）
- **関数名**: camelCase（例: `handleSubmit`）
- **定数**: UPPER_SNAKE_CASE（例: `MAX_PEOPLE`）
- **日本語UI**: すべてのユーザー向けメッセージは日本語で記述

## 機能チェックリスト

### 環境セットアップ

- [ ] Docker Desktop起動
- [ ] Supabaseローカル環境起動 (`supabase start`)
- [ ] データベースリセット (`supabase db reset`)
- [ ] テストデータ適用確認（職員ID 99001-99010の存在確認）

### 基本機能

#### 認証・ログイン
- [ ] 組織コード認証（初回アクセス）
- [ ] 新規ユーザー登録（職員ID、氏名、パスワード）
- [ ] ログイン機能（職員ID、パスワード）
- [ ] ログアウト機能

#### ユーザー機能（一般職員）
- [ ] ホーム画面表示
- [ ] 個人情報設定（氏名・パスワード変更）
- [ ] 年休申請（レベル1・2・3、全日・AM・PM）
- [ ] 申請一覧表示（自分の申請のみ）
- [ ] 申請キャンセル（抽選参加期間内のレベル1・2、確定前のレベル3）
- [ ] 年休カレンダー表示（全職員の申請状況）

#### 管理者機能
- [ ] 管理者設定（組織コード変更、抽選期間設定）
- [ ] メンバー管理（管理者権限付与・削除）
- [ ] 祝日・主要学会管理（追加・編集・削除）
- [ ] マンパワー設定（日別）
- [ ] 抽選実施（一括・日別）
- [ ] 確定処理（一括・日別）
- [ ] 確定解除（個別）
- [ ] 承認待ち申請管理（承認・却下）
- [ ] 管理カレンダー表示

### バージョン 1.1 新機能

#### 動的判定機能
- [ ] **カレンダー表示の動的判定**
  - テスト: 2026年2月の申請を作成（抽選期間: 2025年11月1-15日と仮定）
  - システム日付を11月1-15日に設定 → カレンダーに2月の申請が**非表示**
  - システム日付を11月16日以降に設定 → カレンダーに2月の申請が**表示**
  - 設定で `show_lottery_period_applications = true` → 常に表示
  - 設定で `show_lottery_period_applications = false` → 動的判定

- [ ] **優先順位表示の動的判定**
  - テスト: 申請一覧で優先順位の表示確認
  - 抽選期間中 → 優先順位**非表示**
  - 抽選期間外 → 優先順位**表示**
  - キャンセル済み → 常に非表示

#### 申請制限機能
- [ ] **レベル3の申請制限**
  - テスト: 2026年2月の年休をレベル3で申請（抽選期間: 2025年11月1-15日と仮定）
  - 10月31日以前に申請 → エラー「レベル3は抽選参加期間以降のみ申請可能です」
  - 11月1日以降に申請 → 申請可能

- [ ] **既存のレベル1・2の申請制限**
  - レベル1・2は抽選期間内のみ申請可能
  - 抽選期間外に申請 → エラー「レベル1・2は抽選参加期間内のみ申請可能です」

- [ ] **レベル1・2のキャンセル制限（動的判定）**
  - テスト: 2026年2月のレベル1申請を作成（抽選期間: 2025年11月1-15日と仮定）
  - 11月1-15日の間 → キャンセルボタン**表示**、キャンセル**可能**
  - 11月16日以降 → キャンセルボタン**非表示**、キャンセル**不可**
  - レベル3は確定・取り消し・承認待ち前なら常にキャンセル可能

### 詳細機能テスト

#### 年休申請フロー
- [ ] レベル1申請 → 抽選実施 → 優先順位付与 → 確定処理 → 確定
- [ ] レベル2申請 → 抽選実施 → 優先順位付与 → 確定処理 → 確定
- [ ] レベル3申請（期間内） → 抽選実施 → 優先順位付与 → 確定処理
- [ ] レベル3申請（期間外） → 優先順位付与 → 確定処理
- [ ] レベル3申請（確定後、余裕あり） → 承認待ち → 承認 → 確定
- [ ] レベル3申請（確定後、余裕なし） → エラー「マンパワーの上限に達しているため申請できません」

#### バリデーション
- [ ] 未来日以外の申請 → エラー
- [ ] 日曜日の申請 → エラー
- [ ] 祝日・主要学会の申請 → エラー
- [ ] 土曜日のPM申請 → エラー
- [ ] 重複申請（同一日付） → エラー

#### エッジケース
- [ ] 抽選実施時のレベル別シャッフル確認
- [ ] マンパワー上限での取り消し処理
- [ ] 優先順位の再計算（キャンセル時）
- [ ] 複数管理者の同時操作
- [ ] 管理者権限の最後の1人削除防止

### パフォーマンス
- [ ] 月別カレンダー表示の速度（100件以上の申請）
- [ ] 一括抽選処理の速度（1ヶ月分）
- [ ] 一括確定処理の速度（1ヶ月分）

### セキュリティ
- [ ] 非ログイン時のリダイレクト
- [ ] 一般ユーザーの管理画面アクセス制限
- [ ] パスワードの暗号化（注: 現在は平文保存のため要改善）
- [ ] 組織コード認証

### ドキュメント
- [ ] README.mdの内容が最新
- [ ] TEST_DATA.mdの内容が正確
- [ ] マイグレーションファイルの順序確認
- [ ] 変更履歴の更新

### 2024-11-29 - バージョン 2.0

**予定表管理システムの大幅拡張**

- **当直・シフト管理機能**
  - 当直自動割り振り機能（条件に基づく候補者選択）
  - 一般シフト自動割り振り機能
  - プリセット機能（割り振り設定の保存・読み込み）
  - 祝日・祝前日オプション対応
  - 提出ロック機能（月別）

- **得点ベース割り振り機能**
  - 得点設定マスタ（score_config）の追加
  - 回数ベース/得点ベースの切り替え可能
  - 割り振りごとに得点を再計算（偏り防止）
  - プリセットへの優先モード保存

- **研鑽日システム年度管理**
  - 年度計算ロジック（当直日: 2月〜1月 → 4月〜3月年度）
  - 年度別残高管理（付与/消費/残高）
  - 年度末消滅（繰越なし）
  - 承認後すぐに使用可能
  - UIに年度セレクター追加

- **メンバー設定拡張**
  - 職位（position）カラム追加
  - メンバー回数カウント設定（member_count_config）
  - 表示順序管理

**新規マイグレーション**
- `20241129000002_create_member_count_config.sql` - メンバー回数カウント設定
- `20241129000003_create_score_config.sql` - 得点設定
- `20241129000004_add_user_position.sql` - ユーザー職位
- `20241129000005_add_count_config_filter_positions.sql` - カウント設定職位フィルター
- `20241129000006_create_duty_assign_preset.sql` - 当直割り振りプリセット
- `20241129000007_add_shift_preset_pre_holidays.sql` - シフトプリセット祝前日
- `20241129000008_add_submission_lock.sql` - 提出ロック
- `20241129000009_add_priority_mode_to_presets.sql` - 優先モード
- `20241129000010_add_fiscal_year_to_kensanbi.sql` - 研鑽日年度管理

**データベース構造の拡張**
- `user` テーブル: `position` カラム追加
- `kensanbi_grant_history` テーブル: `fiscal_year` カラム追加
- `kensanbi_usage_history` テーブル: `fiscal_year` カラム追加
- `duty_assign_preset` テーブル: `priority_mode` カラム追加
- `shift_assign_preset` テーブル: `priority_mode` カラム追加
- `schedule_publish` テーブル: `is_submission_locked` カラム追加
- 新規テーブル: `member_count_config`, `score_config`

## 既知の問題・今後の改善点

### セキュリティ
- パスワードが平文保存されている → bcryptなどでハッシュ化が必要
- セッション管理の強化が必要

### パフォーマンス
- 動的判定処理で複数回のDB問い合わせ → キャッシュ機構の導入検討

### 機能追加候補
- メール通知機能（抽選結果、確定通知など）
- 申請履歴のエクスポート機能
- ダークモード対応
